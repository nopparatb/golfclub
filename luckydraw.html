<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>KPMG Golf Charity Lucky Draw</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .fade-swap { transition: opacity 120ms linear, transform 120ms ease; }
    .pulse-glow {
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.6);
      animation: pulseGlow 1.4s ease-out 2;
    }
    @keyframes pulseGlow {
      0% { box-shadow: 0 0 0 0 rgba(34,197,94,.6); }
      100% { box-shadow: 0 0 0 18px rgba(34,197,94,0); }
    }
    .shake {
      animation: shake 280ms ease-in-out;
    }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20% { transform: translateX(-3px); }
      40% { transform: translateX(3px); }
      60% { transform: translateX(-2px); }
      80% { transform: translateX(2px); }
    }
    /* Confetti bits */
    .confetti { position: absolute; width: 6px; height: 10px; opacity: 0; transform: translateY(0); }
    @keyframes confettiFall {
      0%   { opacity: 1; transform: translateY(0) rotate(0deg); }
      100% { opacity: 0; transform: translateY(80px) rotate(320deg); }
    }
  </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-900 selection:bg-indigo-200 selection:text-gray-900">

  <!-- Settings (top-right) -->
  <button
    id="openSettings"
    class="fixed right-3 top-3 z-30 inline-flex h-10 w-10 items-center justify-center rounded-full bg-white/90 shadow ring-1 ring-black/10 hover:bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
    title="Edit alternation speed (ms)"
    aria-label="Edit alternation speed"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
        d="M16.862 3.487a1.5 1.5 0 0 1 2.121 0l1.53 1.53a1.5 1.5 0 0 1 0 2.121L9.75 17.922l-4.5 1.125 1.125-4.5L16.862 3.487z"/>
    </svg>
  </button>

  <div
    id="settingsPanel"
    class="fixed right-3 top-16 z-30 hidden w-72 rounded-2xl bg-white p-4 shadow-xl ring-1 ring-black/10"
    role="dialog" aria-modal="true" aria-labelledby="settingsTitle"
  >
    <div class="flex items-start justify-between">
      <h2 id="settingsTitle" class="text-sm font-semibold tracking-wide text-gray-700">Alternation Settings</h2>
      <button id="closeSettings" class="rounded-lg p-1 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Close settings">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" stroke="currentColor" fill="none">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="mt-3 space-y-3">
      <label class="block text-xs text-gray-600" for="intervalInput">Base flip interval (ms)</label>
      <input id="intervalInput" type="number" min="20" step="10"
             class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
             value="55" />
      <p class="text-[11px] text-gray-500">
        The shuffle starts fast at this interval and decelerates smoothly until it stops.
      </p>
      <label class="block text-xs text-gray-600" for="durationInput">Total spin duration (ms)</label>
      <input id="durationInput" type="number" min="600" step="100"
             class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-indigo-500 focus:outline-none focus:ring-2 focus:ring-indigo-200"
             value="5000" />
      <div class="flex items-center justify-end gap-2 pt-1">
        <button id="resetDefaults" class="rounded-lg px-3 py-2 text-xs font-medium text-gray-600 hover:bg-gray-100">Reset</button>
        <button id="saveSettings" class="rounded-lg bg-indigo-600 px-3 py-2 text-xs font-semibold text-white hover:bg-indigo-700">Save</button>
      </div>
    </div>
  </div>

  <main class="relative mx-auto flex min-h-screen max-w-4xl flex-col px-4 pb-28 pt-14 sm:pt-16">
    <!-- Display area -->
    <section class="flex flex-1 items-center justify-center">
      <div id="card"
           class="relative aspect-[4/3] w-full max-w-xl overflow-hidden rounded-2xl bg-white shadow-lg ring-1 ring-black/10">
        <!-- Progress bar (top) -->
        <div id="progressWrap" class="absolute left-0 right-0 top-0 h-1.5 bg-transparent">
          <div id="progressBar" class="h-full w-0 bg-indigo-500 transition-[width] duration-100 linear"></div>
        </div>

        <!-- Image -->
        <img id="displayImg" src="" alt="Randomized result"
             class="fade-swap h-full w-full object-contain opacity-0"
             draggable="false" />

        <!-- Shuffle overlay -->
        <div id="shuffleOverlay"
             class="pointer-events-none absolute inset-0 hidden items-center justify-center">
          <div class="absolute inset-0 bg-white/60 backdrop-blur-sm"></div>
          <!-- diagonal streaks -->
          <div class="absolute inset-0 opacity-20"
               style="background-image: repeating-linear-gradient(135deg, rgba(0,0,0,.06) 0 8px, transparent 8px 16px);"></div>
          <div class="relative z-10 flex flex-col items-center gap-2">
            <div class="h-8 w-8 animate-spin rounded-full border-2 border-indigo-600 border-t-transparent"></div>
            <div class="text-xs font-medium text-gray-700">Shufflingâ€¦</div>
          </div>
        </div>

        <!-- Result badge -->
        <div id="resultBadge"
             class="pointer-events-none absolute left-3 top-3 hidden select-none rounded-full bg-emerald-50 px-3 py-1 text-xs font-semibold text-emerald-700 ring-1 ring-emerald-200">
          Result locked
        </div>

        <!-- Confetti container -->
        <div id="confetti" class="pointer-events-none absolute inset-0"></div>

        <!-- Fallback hint -->
        <div id="fallbackText"
             class="pointer-events-none absolute inset-0 hidden items-center justify-center text-center text-sm text-gray-500">
          Place two images at <code class="rounded bg-gray-100 px-1 py-0.5">./assets/KPMG1.jpeg</code> and
          <code class="rounded bg-gray-100 px-1 py-0.5">./assets/KPMG2.png</code>.
        </div>
      </div>
    </section>

    <!-- Control button -->
    <button
      id="randomBtn"
      class="group fixed left-1/2 top-1/2 z-20 -translate-x-1/2 -translate-y-1/2 select-none rounded-2xl bg-indigo-600 px-6 py-3 text-base font-semibold text-white shadow-lg ring-1 ring-black/10 transition hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-300 sm:px-8 sm:py-3.5">
      <span class="inline-flex items-center gap-2">
        Randomize
        <svg class="h-5 w-5 transition group-hover:rotate-12" xmlns="http://www.w3.org/2000/svg" fill="none"
             viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M16.5 3.5l4 4m0 0l-4 4m4-4H9.5a6 6 0 100 12h.5"/>
        </svg>
      </span>
    </button>
  </main>

  <!-- ðŸ”¥ Firebase + Firestore + existing logic (now as ES module) -->
 <script type="module">
  /*************** Firebase setup ***************/
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js';
  import {
    getFirestore,
    doc,
    setDoc,
    onSnapshot,
    serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyDxlQWFYRcbGZ133HPEMXYy8tR_KMUiJw0",
    authDomain: "lottogame-16083.firebaseapp.com",
    projectId: "lottogame-16083",
    storageBucket: "lottogame-16083.firebasestorage.app",
    messagingSenderId: "278778623701",
    appId: "1:278778623701:web:c7828b036c617a13fa145c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Collection: golfluckydraw, Document: currentResult
  const resultDocRef = doc(db, 'golfluckydraw', 'currentResult');

  /*************** Config & state ***************/
  // Editable via settings
  let baseFlipIntervalMs = 55;   // starting flip cadence
  let spinDurationMs = 5000;     // total duration
  const minInterval = 20;
  const defaultBase = 55;
  const defaultDuration = 5000;
  const maxFlipIntervalMs = 260; // Max delay at the end of deceleration

  // Shared spin state
  let isSpinning = false;
  let showingIndex = 0;
  let hasShownOnce = false;
  let nextFlipAt = 0;

  // Multi-client sync state
  let lastKnownState = 'idle';
  let lastSpinIdStarted = null;
  let activeSpinId = null;
  let activeResult = null;          // 0 or 1
  let isInitiatorForActiveSpin = false;
  let pendingLocalSpinId = null;    // used to know if this client initiated

  /*************** DOM refs ***************/
  const imgEl = document.getElementById('displayImg');
  const randomBtn = document.getElementById('randomBtn');
  const resultBadge = document.getElementById('resultBadge');
  const fallbackText = document.getElementById('fallbackText');
  const overlay = document.getElementById('shuffleOverlay');
  const progressBar = document.getElementById('progressBar');
  const progressWrap = document.getElementById('progressWrap');
  const card = document.getElementById('card');
  const confettiWrap = document.getElementById('confetti');

  const openSettings = document.getElementById('openSettings');
  const settingsPanel = document.getElementById('settingsPanel');
  const closeSettings = document.getElementById('closeSettings');
  const intervalInput = document.getElementById('intervalInput');
  const durationInput = document.getElementById('durationInput');
  const saveSettings = document.getElementById('saveSettings');
  const resetDefaults = document.getElementById('resetDefaults');

  /*************** Images ***************/
  const sources = ['./assets/KPMG1.jpeg', './assets/KPMG2.png'];
  const preloaded = [];
  let canShow = false;

  function preloadImages() {
    let loaded = 0;
    sources.forEach((src, i) => {
      const im = new Image();
      im.onload = () => {
        loaded++;
        if (loaded === sources.length) {
          canShow = true;
          fallbackText.classList.add('hidden');
          imgEl.src = sources[0];
          imgEl.style.opacity = '1';
        }
      };
      im.onerror = () => {
        fallbackText.classList.remove('hidden');
        imgEl.style.opacity = '0';
      };
      im.src = src;
      preloaded[i] = im;
    });
  }
  preloadImages();

  /*************** Helpers ***************/
  function moveButtonToLowerCenter() {
    randomBtn.classList.remove('top-1/2', '-translate-y-1/2');
    randomBtn.classList.add('bottom-8');
    randomBtn.style.top = '';
  }

  function easeOutQuad(t) {
    return 1 - (1 - t) * (1 - t);
  }

  function createConfettiBurst() {
    confettiWrap.innerHTML = '';
    const colors = ['#22c55e', '#10b981', '#3b82f6', '#f59e0b', '#ef4444', '#8b5cf6'];
    const count = 18;
    for (let i = 0; i < count; i++) {
      const piece = document.createElement('span');
      piece.className = 'confetti';
      piece.style.left = (45 + Math.random() * 10) + '%';
      piece.style.top = '12%';
      piece.style.background = colors[i % colors.length];
      piece.style.borderRadius = Math.random() > 0.5 ? '2px' : '0';
      piece.style.animation = `confettiFall ${800 + Math.random() * 600}ms ease-out forwards`;
      piece.style.transform = `translateY(0) rotate(${Math.random() * 160 - 80}deg)`;
      confettiWrap.appendChild(piece);
    }
    setTimeout(() => confettiWrap.innerHTML = '', 1800);
  }

  function setControlsDisabled(disabled) {
    // Button + settings icon disabled on all clients while spinning
    const controls = [randomBtn, openSettings];
    controls.forEach((el) => {
      if (!el) return;
      el.disabled = disabled;
      if (disabled) {
        el.classList.add('opacity-60', 'cursor-not-allowed');
      } else {
        el.classList.remove('opacity-60', 'cursor-not-allowed');
      }
    });
  }

  // Centralized final result display
  function showResult(index, { playCelebration = false } = {}) {
    if (!canShow) return;

    imgEl.style.opacity = '0.25';
    setTimeout(() => {
      imgEl.src = sources[index];
      imgEl.style.opacity = '1';
      imgEl.style.filter = 'none';
      imgEl.style.transform = 'none';
    }, 80);

    showingIndex = index;
    resultBadge.textContent = 'Result locked';
    resultBadge.classList.remove('hidden');
    card.classList.add('pulse-glow');
    if (playCelebration) createConfettiBurst();

    if (!hasShownOnce) {
      moveButtonToLowerCenter();
      hasShownOnce = true;
    }
  }

  /*************** Shared spin animation ***************/
  function startSharedSpinAnimation(finalResultIndex, duration, baseInterval) {
    if (!canShow || isSpinning) return;
    isSpinning = true;
    activeResult = finalResultIndex;

    if (typeof duration === 'number') spinDurationMs = duration;
    if (typeof baseInterval === 'number') baseFlipIntervalMs = baseInterval;

    resultBadge.classList.add('hidden');

    // Visuals
    overlay.classList.remove('hidden');
    progressWrap.classList.remove('bg-transparent');
    imgEl.style.filter = 'blur(2px)';
    imgEl.style.transform = 'scale(1.01)';
    card.classList.remove('pulse-glow');
    setControlsDisabled(true);

    const start = performance.now();
    nextFlipAt = start;

    function tick(now) {
      const elapsed = now - start;
      const t = Math.min(1, elapsed / spinDurationMs); // 0..1
      const currentDelay = baseFlipIntervalMs +
        (maxFlipIntervalMs - baseFlipIntervalMs) * easeOutQuad(t);

      // Progress bar
      progressBar.style.width = (t * 100).toFixed(2) + '%';

      // Mild shake at the start
      if (elapsed < 320 && Math.random() < 0.35) {
        card.classList.add('shake');
        setTimeout(() => card.classList.remove('shake'), 140);
      }

      // Flip when time
      if (now >= nextFlipAt) {
        showingIndex = 1 - showingIndex;
        imgEl.style.opacity = '0.25';
        imgEl.style.transform = 'scale(1.012)';
        setTimeout(() => {
          imgEl.src = sources[showingIndex];
          imgEl.style.opacity = '1';
          imgEl.style.transform = 'scale(1.01)';
        }, 40);
        nextFlipAt = now + currentDelay;
      }

      if (elapsed < spinDurationMs) {
        requestAnimationFrame(tick);
      } else {
        // Stop & finalize UI
        overlay.classList.add('hidden');
        progressBar.style.width = '0%';
        isSpinning = false;
        setControlsDisabled(false);

        // Everyone shows the same final result
        if (typeof activeResult === 'number') {
          showResult(activeResult, { playCelebration: true });
        }

        // Only the initiator updates Firestore state to "result"
        if (isInitiatorForActiveSpin && activeSpinId) {
          finalizeSpinInFirestore(activeSpinId, activeResult);
        }
      }
    }

    requestAnimationFrame(tick);
  }

  async function finalizeSpinInFirestore(spinId, resultIndex) {
    try {
      await setDoc(resultDocRef, {
        state: 'result',
        spinId,
        result: resultIndex,
        finishedAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      }, { merge: true });
    } catch (err) {
      console.error('Failed to finalize spin:', err);
    }
  }

  /*************** Trigger spin (from button) ***************/
  function createSpinId() {
    if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
    return 'spin-' + Date.now() + '-' + Math.random().toString(16).slice(2);
  }

  async function triggerSpin() {
    if (!canShow || isSpinning || lastKnownState === 'spinning') return;

    const spinId = createSpinId();
    pendingLocalSpinId = spinId;
    isInitiatorForActiveSpin = true;

    // Decide the shared result up front so all devices match
    const chosenResult = Math.random() < 0.5 ? 0 : 1;

    try {
      await setDoc(resultDocRef, {
        state: 'spinning',
        spinId,
        result: chosenResult,
        baseFlipMs: baseFlipIntervalMs,
        spinDurationMs,
        startedAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
    } catch (err) {
      console.error('Failed to trigger spin:', err);
      // If write fails, this client should not act like the initiator
      isInitiatorForActiveSpin = false;
      pendingLocalSpinId = null;
    }
  }

  randomBtn.addEventListener('click', triggerSpin);

  /*************** Settings UI ***************/
  function toggleSettings(open) {
    if (open) {
      intervalInput.value = String(baseFlipIntervalMs);
      durationInput.value = String(spinDurationMs);
      settingsPanel.classList.remove('hidden');
    } else {
      settingsPanel.classList.add('hidden');
    }
  }

  openSettings.addEventListener('click', () => toggleSettings(true));
  closeSettings.addEventListener('click', () => toggleSettings(false));

  saveSettings.addEventListener('click', () => {
    const iv = parseInt(intervalInput.value, 10);
    const du = parseInt(durationInput.value, 10);
    if (!Number.isFinite(iv) || iv < minInterval) {
      alert(`Base interval must be a number â‰¥ ${minInterval} ms.`);
      return;
    }
    if (!Number.isFinite(du) || du < 600) {
      alert('Duration must be a number â‰¥ 600 ms.');
      return;
    }
    baseFlipIntervalMs = iv;
    spinDurationMs = du;
    toggleSettings(false);
  });

  resetDefaults.addEventListener('click', () => {
    baseFlipIntervalMs = defaultBase;
    spinDurationMs = defaultDuration;
    intervalInput.value = String(defaultBase);
    durationInput.value = String(defaultDuration);
  });

  // Close settings by clicking outside
  document.addEventListener('click', (e) => {
    if (!settingsPanel.contains(e.target) && e.target !== openSettings && !openSettings.contains(e.target)) {
      toggleSettings(false);
    }
  });

  // ESC to close
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') toggleSettings(false);
  });

  // Respect reduced motion preference
  const mq = window.matchMedia('(prefers-reduced-motion: reduce)');
  if (mq.matches) {
    baseFlipIntervalMs = Math.max(baseFlipIntervalMs, 120);
    spinDurationMs = Math.max(spinDurationMs, 1500);
    imgEl.style.transitionDuration = '200ms';
  }

  /*************** Firestore realtime sync ***************/
  onSnapshot(resultDocRef, (snap) => {
    if (!snap.exists()) return;
    const data = snap.data();

    lastKnownState = data.state || 'idle';

    // Keep activeResult synced with Firestore
    if (typeof data.result === 'number') {
      activeResult = data.result;
    }

    if (lastKnownState === 'spinning') {
      setControlsDisabled(true);

      const spinId = data.spinId;
      const docBase = typeof data.baseFlipMs === 'number' ? data.baseFlipMs : baseFlipIntervalMs;
      const docDur = typeof data.spinDurationMs === 'number' ? data.spinDurationMs : spinDurationMs;

      // If this is a new spin, start animation on this client
      if (spinId && spinId !== lastSpinIdStarted) {
        lastSpinIdStarted = spinId;
        activeSpinId = spinId;

        // Check if this client was the one that triggered it
        if (pendingLocalSpinId && pendingLocalSpinId === spinId) {
          isInitiatorForActiveSpin = true;
        } else {
          isInitiatorForActiveSpin = false;
        }

        if (typeof activeResult !== 'number') activeResult = 0;
        startSharedSpinAnimation(activeResult, docDur, docBase);
      }
    } else if (lastKnownState === 'result') {
      setControlsDisabled(false);

      // If not currently spinning, just show the final result immediately
      if (!isSpinning && typeof data.result === 'number' &&
          data.result >= 0 && data.result < sources.length) {
        showResult(data.result, { playCelebration: false });
      }
    } else {
      // idle
      setControlsDisabled(false);
    }
  });
</script>

</body>
</html>
